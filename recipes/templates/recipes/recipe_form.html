{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - OnlyPans{% endblock %}

{% block content %}
<div class="container my-5">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'recipe_list' %}">Recipes</a></li>
            <li class="breadcrumb-item active">{{ title }}</li>
        </ol>
    </nav>

    <div class="recipe-form-container">
        <h2 class="mb-4">
            <i class="fas fa-plus-circle text-primary me-2"></i>{{ title }}
        </h2>

        <!-- Error Summary -->
        {% if form.errors or ingredient_formset.errors or step_formset.errors %}
        <div class="alert alert-danger" role="alert">
            <h5><i class="fas fa-exclamation-triangle me-2"></i>Please correct the following errors:</h5>
            <ul class="mb-0">
                {% for field in form %}
                    {% if field.errors %}
                        <li>{{ field.label }}: {{ field.errors|first }}</li>
                    {% endif %}
                {% endfor %}
                {% if form.non_field_errors %}
                    {% for error in form.non_field_errors %}
                        <li>{{ error }}</li>
                    {% endfor %}
                {% endif %}
                {% if ingredient_formset.errors %}
                    {% for error in ingredient_formset.non_form_errors %}
                        <li>Ingredients: {{ error }}</li>
                    {% endfor %}
                    {% for formset_form in ingredient_formset %}
                        {% if formset_form.errors %}
                            {% for field_name, errors in formset_form.errors.items %}
                                {% if field_name != '__all__' %}
                                    <li>Ingredient {{ forloop.counter }} - {{ field_name }}: {{ errors|first }}</li>
                                {% else %}
                                    <li>Ingredient {{ forloop.counter }}: {{ errors|first }}</li>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
                {% if step_formset.errors %}
                    {% for error in step_formset.non_form_errors %}
                        <li>Instructions: {{ error }}</li>
                    {% endfor %}
                    {% for formset_form in step_formset %}
                        {% if formset_form.errors %}
                            {% for field_name, errors in formset_form.errors.items %}
                                {% if field_name != '__all__' %}
                                    <li>Step {{ forloop.counter }} - {{ field_name }}: {{ errors|first }}</li>
                                {% else %}
                                    <li>Step {{ forloop.counter }}: {{ errors|first }}</li>
                                {% endif %}
                            {% endfor %}
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </ul>
        </div>
        {% endif %}

        <form method="post" enctype="multipart/form-data" id="recipe-form">
            {% csrf_token %}
            
            <!-- Basic Recipe Info -->
            <div class="form-section">
                <h4><i class="fas fa-info-circle me-2"></i>Basic Information</h4>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label for="{{ form.title.id_for_label }}" class="form-label">Recipe Title *</label>
                            {{ form.title }}
                            {% if form.title.errors %}
                                <div class="invalid-feedback d-block">{{ form.title.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.description.id_for_label }}" class="form-label">Description</label>
                            {{ form.description }}
                            {% if form.description.errors %}
                                <div class="invalid-feedback d-block">{{ form.description.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label for="{{ form.prep_time.id_for_label }}" class="form-label">Prep Time (minutes) *</label>
                            {{ form.prep_time }}
                            {% if form.prep_time.errors %}
                                <div class="invalid-feedback d-block">{{ form.prep_time.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.cook_time.id_for_label }}" class="form-label">Cook Time (minutes) *</label>
                            {{ form.cook_time }}
                            {% if form.cook_time.errors %}
                                <div class="invalid-feedback d-block">{{ form.cook_time.errors }}</div>
                            {% endif %}
                        </div>
                        
                        <div class="mb-3">
                            <label for="{{ form.servings.id_for_label }}" class="form-label">Servings *</label>
                            {{ form.servings }}
                            {% if form.servings.errors %}
                                <div class="invalid-feedback d-block">{{ form.servings.errors }}</div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Recipe Image -->
            <div class="form-section">
                <h4><i class="fas fa-camera me-2"></i>Recipe Image</h4>
                
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.image.id_for_label }}" class="form-label">Upload Image</label>
                            {{ form.image }}
                            {% if form.image.errors %}
                                <div class="invalid-feedback d-block">{{ form.image.errors }}</div>
                            {% endif %}
                            <div class="form-text">Upload a photo of your finished dish (optional)</div>
                        </div>
                    </div>
                    
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.image_url.id_for_label }}" class="form-label">Or Image URL</label>
                            {{ form.image_url }}
                            {% if form.image_url.errors %}
                                <div class="invalid-feedback d-block">{{ form.image_url.errors }}</div>
                            {% endif %}
                            <div class="form-text">Or paste a link to an image online</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tags -->
            <div class="form-section">
                <h4><i class="fas fa-tags me-2"></i>Tags</h4>
                <p class="text-muted small mb-3">{{ form.tags.help_text }}</p>
                
                <div class="tag-categories">
                    {% regroup form.tags.field.queryset by tag_type as tags_by_type %}
                    {% for tag_type in tags_by_type %}
                        <div class="tag-category mb-4">
                            <h6 class="tag-category-title">
                                <i class="fas fa-{% if tag_type.grouper == 'dietary' %}leaf{% elif tag_type.grouper == 'cuisine' %}globe{% elif tag_type.grouper == 'meal_type' %}clock{% elif tag_type.grouper == 'cooking_method' %}fire{% else %}star{% endif %} me-2"></i>
                                {{ tag_type.list.0.get_tag_type_display }}
                            </h6>
                            <div class="tag-selection">
                                {% for tag in tag_type.list %}
                                    <input type="checkbox" class="tag-checkbox d-none" 
                                           id="id_tags_{{ tag.id }}" 
                                           name="tags" 
                                           value="{{ tag.id }}" 
                                           {% if form.tags.value and tag.id in form.tags.value %}checked{% endif %}>
                                    <label for="id_tags_{{ tag.id }}" class="tag tag-selectable me-2 mb-2" 
                                           style="background-color: {{ tag.color }};"
                                           title="{{ tag.name }} - {{ tag.get_tag_type_display }}">
                                        {{ tag.name }}
                                    </label>
                                {% endfor %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                {% if form.tags.errors %}
                    <div class="invalid-feedback d-block">{{ form.tags.errors }}</div>
                {% endif %}
            </div>

            <!-- Ingredients -->
            <div class="form-section">
                <h4><i class="fas fa-shopping-list me-2"></i>Ingredients</h4>
                
                <div id="ingredient-formset">
                    {{ ingredient_formset.management_form }}
                    {% for form in ingredient_formset %}
                        <div class="ingredient-row">
                            <div class="row align-items-center">
                                <div class="col-md-4">
                                    <label class="form-label">Ingredient</label>
                                    {{ form.ingredient }}
                                    {% if form.ingredient.errors %}
                                        <div class="invalid-feedback d-block">{{ form.ingredient.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Quantity</label>
                                    {{ form.quantity }}
                                    {% if form.quantity.errors %}
                                        <div class="invalid-feedback d-block">{{ form.quantity.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label">Unit</label>
                                    {{ form.unit }}
                                    {% if form.unit.errors %}
                                        <div class="invalid-feedback d-block">{{ form.unit.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Notes</label>
                                    {{ form.notes }}
                                    {% if form.notes.errors %}
                                        <div class="invalid-feedback d-block">{{ form.notes.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn delete-row" onclick="removeRow(this)" aria-label="Remove this ingredient">
                                        <i class="fas fa-trash" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                            {{ form.order.as_hidden }}
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
                
                <button type="button" class="btn add-row mt-2" onclick="addIngredientRow()" aria-label="Add a new ingredient">
                    <i class="fas fa-plus me-2" aria-hidden="true"></i>Add Ingredient
                </button>
            </div>

            <!-- Steps -->
            <div class="form-section">
                <h4><i class="fas fa-list-ol me-2"></i>Instructions</h4>
                
                <div id="step-formset">
                    {{ step_formset.management_form }}
                    {% for form in step_formset %}
                        <div class="step-row">
                            <div class="row">
                                <div class="col-md-1">
                                    <label class="form-label">Step</label>
                                    {{ form.step_number }}
                                    {% if form.step_number.errors %}
                                        <div class="invalid-feedback d-block">{{ form.step_number.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-7">
                                    <label class="form-label">Instruction</label>
                                    {{ form.instruction }}
                                    {% if form.instruction.errors %}
                                        <div class="invalid-feedback d-block">{{ form.instruction.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label">Step Image</label>
                                    {{ form.image }}
                                    {% if form.image.errors %}
                                        <div class="invalid-feedback d-block">{{ form.image.errors }}</div>
                                    {% endif %}
                                </div>
                                <div class="col-md-1">
                                    <label class="form-label">&nbsp;</label>
                                    <button type="button" class="btn delete-row" onclick="removeRow(this)" aria-label="Remove this step">
                                        <i class="fas fa-trash" aria-hidden="true"></i>
                                    </button>
                                </div>
                            </div>
                            {% for hidden in form.hidden_fields %}
                                {{ hidden }}
                            {% endfor %}
                        </div>
                    {% endfor %}
                </div>
                
                <button type="button" class="btn add-row mt-2" onclick="addStepRow()" aria-label="Add a new step">
                    <i class="fas fa-plus me-2" aria-hidden="true"></i>Add Step
                </button>
            </div>

            <!-- Submit Buttons -->
            <div class="text-center mt-4">
                <button type="submit" class="btn btn-primary btn-lg me-3" aria-label="Save recipe">
                    <i class="fas fa-save me-2" aria-hidden="true"></i>Save Recipe
                </button>
                <a href="{% url 'recipe_list' %}" class="btn btn-secondary btn-lg">
                    <i class="fas fa-times me-2" aria-hidden="true"></i>Cancel
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-populate order numbers
    updateOrderNumbers();
    
    // Debug form submission
    const form = document.getElementById('recipe-form');
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('Form submitted!');
            updateOrderNumbers(); // Update before submission
            // Don't prevent default - let it submit normally
        });
    }
    
    // Initialize Select2 for ingredient dropdowns
    if (typeof $ !== 'undefined' && $.fn.select2) {
        $('.ingredient-select').select2({
            placeholder: 'Search ingredients...',
            allowClear: true,
            width: '100%'
        });
    }
});

function updateOrderNumbers() {
    // Update ingredient order numbers
    document.querySelectorAll('#ingredient-formset .ingredient-row').forEach((row, index) => {
        const orderInput = row.querySelector('.ingredient-order');
        if (orderInput) {
            orderInput.value = index + 1;
        }
    });
    
    // Update step numbers
    document.querySelectorAll('#step-formset .step-row').forEach((row, index) => {
        const stepNumberInput = row.querySelector('.step-number');
        if (stepNumberInput) {
            stepNumberInput.value = index + 1;
        }
    });
}

// Override the add row functions to update order numbers
if (typeof window.addIngredientRow === 'function') {
    const originalAddIngredientRow = window.addIngredientRow;
    window.addIngredientRow = function() {
        originalAddIngredientRow();
        setTimeout(updateOrderNumbers, 100);
    };
}

if (typeof window.addStepRow === 'function') {
    const originalAddStepRow = window.addStepRow;
    window.addStepRow = function() {
        originalAddStepRow();
        setTimeout(updateOrderNumbers, 100);
    };
}
</script>

{% endblock %}