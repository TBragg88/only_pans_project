{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>
            {% block title %}OnlyPans - Recipe Collection{% endblock %}
        </title>
        
    <!-- SEO basics: description + canonical (override per page via blocks) -->
    {% block meta_description %}
    <meta name="description" content="Create, discover, and discuss great recipes with a friendly OnlyPans community.">
    {% endblock %}
    {% block canonical %}
    <link rel="canonical" href="{{ request.build_absolute_uri }}">
    {% endblock %}

    <!-- Favicon & PWA basics -->
    <link rel="icon" href="{% static 'images/favicons/favicon.svg' %}" type="image/svg+xml">
    <link rel="manifest" href="{% static 'images/favicons/site.webmanifest' %}">
    <meta name="theme-color" content="#0051a8">

    <!-- Default Social Sharing (can be overridden per page) -->
    <meta property="og:site_name" content="OnlyPans">
    <meta property="og:type" content="website">
    <meta property="og:title" content="OnlyPans — Discover and share recipes">
    <meta property="og:description" content="Create, discover, and discuss great recipes with a friendly community.">
    <meta property="og:image" content="{% static 'images/favicons/favicon.svg' %}">
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="OnlyPans — Discover and share recipes">
    <meta name="twitter:description" content="Create, discover, and discuss great recipes with a friendly community.">

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-LN+7fdVzj6u52u30Kp6M/trliBMCMKTyK833zpbD+pXdCLuTusPj697FH4R/5mcr"
            crossorigin="anonymous"
        />
        <!-- Font Awesome for icons -->
        <link
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
            rel="stylesheet"
            integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
            crossorigin="anonymous"
        />
        <!-- Custom CSS -->
        <link href="{% static 'css/styles.css' %}" rel="stylesheet" />

        {% block extra_css %}{% endblock %}
    </head>
    <body>
    <!-- Accessibility: Skip to main content -->
    <a href="#main-content" class="visually-hidden-focusable position-absolute top-0 start-0 m-2 px-3 py-2 bg-light rounded text-dark" style="z-index: 1050;">Skip to content</a>
        <!-- Clean Navigation Header -->
        <nav class="navbar navbar-dark bg-dark py-2">
            <div class="container">
                <div class="d-flex w-100 justify-content-between align-items-center">
                    <!-- Left side: Welcome message -->
                    {% if user.is_authenticated %}
                    <small class="text-light">
                        Welcome, {% if user.first_name %}{{ user.first_name|title }}{% else %}{{ user.username|title }}{% endif %}
                    </small>
                    {% else %}
                    <div></div> <!-- Empty div for spacing when not authenticated -->
                    {% endif %}
                    
                    <!-- Right side: Button group -->
                    <div class="d-flex align-items-center">
                        {% if user.is_authenticated %}
                        <!-- Icon-only buttons with proper accessibility -->
                        <a class="btn btn-sm me-2" 
                           href="{% url 'accounts:profile' %}" 
                           aria-label="View Profile"
                           title="Profile">
                            <i class="fas fa-user" aria-hidden="true"></i>
                        </a>
                        
                                <a class="btn btn-sm me-2" 
                                    href="{% url 'recipes:liked_recipes' %}" 
                           aria-label="View Liked Recipes"
                           title="Liked Recipes">
                            <i class="fas fa-heart" aria-hidden="true"></i>
                        </a>
                        
                                <a class="btn btn-sm me-2" 
                                    href="{% url 'recipes:recipe_create' %}" 
                           aria-label="Create New Recipe"
                           title="Create Recipe">
                            <i class="fas fa-plus" aria-hidden="true"></i>
                        </a>
                        
                        <a class="btn btn-sm" 
                           href="#" 
                           id="logoutBtn" 
                           aria-label="Sign Out"
                           title="Logout">
                            <i class="fas fa-sign-out-alt" aria-hidden="true"></i>
                        </a>
                        
                        {% else %}
                        <button class="btn btn-sm me-2" 
                                data-bs-toggle="modal" 
                                data-bs-target="#loginModal"
                                aria-label="Sign In">
                            <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                        </button>
                        <button class="btn btn-sm" 
                                data-bs-toggle="modal" 
                                data-bs-target="#registerModal"
                                aria-label="Register Account">
                            <i class="fas fa-user-plus" aria-hidden="true"></i>
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </nav>

        <!-- OnlyPans Hero Section -->
        <section class="onlypans-hero">
            <div class="container text-center">
                <h1 class="hero-brand">
                    <a href="{% url 'recipes:recipe_list' %}" class="text-decoration-none">
                        <span class="brand-highlight">OnlyPans</span>
                    </a>
                </h1>
            </div>
        </section>

        <!-- Main Content: Recipe Grid -->
    <main id="main-content" class="container mb-5">{% block content %}{% endblock %}</main>

        <!-- Footer -->
        <footer class="bg-dark text-light py-4 mt-auto">
            <div class="container">
                <div class="row align-items-center mb-3">
                    <div class="col-md-6">
                        <h5><i class="fas fa-utensils me-2"></i>OnlyPans</h5>
                    </div>
                    <div class="col-md-6 text-end">
                        <a href="https://facebook.com" class="text-light me-3" aria-label="Follow us on Facebook" target="_blank" rel="noopener noreferrer"
                            ><i class="fab fa-facebook fa-lg" aria-hidden="true"></i
                        ></a>
                        <a href="https://twitter.com" class="text-light me-3" aria-label="Follow us on Twitter" target="_blank" rel="noopener noreferrer"
                            ><i class="fab fa-twitter fa-lg" aria-hidden="true"></i
                        ></a>
                        <a href="https://instagram.com" class="text-light me-3" aria-label="Follow us on Instagram" target="_blank" rel="noopener noreferrer"
                            ><i class="fab fa-instagram fa-lg" aria-hidden="true"></i
                        ></a>
                        <a href="https://youtube.com" class="text-light" aria-label="Subscribe to our YouTube channel" target="_blank" rel="noopener noreferrer"
                            ><i class="fab fa-youtube fa-lg" aria-hidden="true"></i
                        ></a>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12 text-center">
                        <a href="{% url 'about' %}" class="text-light me-3">About Us</a>
                        <a href="#" class="text-light me-3" data-bs-toggle="modal" data-bs-target="#contactModal">Contact Us</a>
                        <a href="{% url 'privacy' %}" class="text-light me-3">Privacy</a>
                        <a href="{% url 'terms' %}" class="text-light me-3">Terms</a>
                        <span class="text-muted">&copy; 2025 OnlyPans</span>
                    </div>
                </div>
            </div>
        </footer>

        <!-- Login Modal -->
        <div
            class="modal fade"
            id="loginModal"
            tabindex="-1"
            aria-labelledby="loginModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="loginModalLabel">
                            Sign In
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <div
                            id="loginErrors"
                            class="alert alert-danger alert-hidden"
                        ></div>
                        <form
                            method="post"
                            action="{% url 'accounts:login' %}"
                            id="loginForm"
                        >
                            {% csrf_token %}
                            <div class="mb-3">
                                <label for="id_username" class="form-label"
                                    >Username</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="id_username"
                                    name="username"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label for="id_password" class="form-label"
                                    >Password</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="id_password"
                                    name="password"
                                    required
                                />
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                Sign In
                            </button>
                        </form>
                        <div class="text-center mt-3">
                            <span>Don't have an account?</span>
                            <a
                                href="#"
                                data-bs-dismiss="modal"
                                data-bs-toggle="modal"
                                data-bs-target="#registerModal"
                                >Register</a
                            >
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Register Modal -->
        <div
            class="modal fade"
            id="registerModal"
            tabindex="-1"
            aria-labelledby="registerModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="registerModalLabel">
                            Register
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <!-- Error display for registration -->
                        <div
                            id="registerErrors"
                            class="alert alert-danger alert-hidden"
                        ></div>

                        <form
                            method="post"
                            action="{% url 'accounts:register' %}"
                            id="registerForm"
                        >
                            {% csrf_token %}
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label
                                        for="reg_first_name"
                                        class="form-label"
                                        >First Name</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="reg_first_name"
                                        name="first_name"
                                        placeholder="First Name"
                                        required
                                    />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label
                                        for="reg_last_name"
                                        class="form-label"
                                        >Last Name</label
                                    >
                                    <input
                                        type="text"
                                        class="form-control"
                                        id="reg_last_name"
                                        name="last_name"
                                        placeholder="Last Name"
                                        required
                                    />
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="reg_username" class="form-label"
                                    >Username</label
                                >
                                <input
                                    type="text"
                                    class="form-control"
                                    id="reg_username"
                                    name="username"
                                    placeholder="Username"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label for="reg_email" class="form-label"
                                    >Email Address</label
                                >
                                <input
                                    type="email"
                                    class="form-control"
                                    id="reg_email"
                                    name="email"
                                    placeholder="Email Address"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label for="reg_password1" class="form-label"
                                    >Password</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="reg_password1"
                                    name="password1"
                                    placeholder="Password"
                                    required
                                />
                            </div>
                            <div class="mb-3">
                                <label for="reg_password2" class="form-label"
                                    >Confirm Password</label
                                >
                                <input
                                    type="password"
                                    class="form-control"
                                    id="reg_password2"
                                    name="password2"
                                    placeholder="Confirm Password"
                                    required
                                />
                            </div>
                            <button type="submit" class="btn btn-primary w-100">
                                Register
                            </button>
                        </form>
                        <div class="text-center mt-3">
                            <span>Already have an account?</span>
                            <a
                                href="#"
                                data-bs-dismiss="modal"
                                data-bs-toggle="modal"
                                data-bs-target="#loginModal"
                                >Sign In</a
                            >
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success Toast for Login/Register - Top Center -->
        <div class="toast-container-auth">
            <div
                id="authToast"
                class="toast toast-min-width"
                role="alert"
                aria-live="assertive"
                aria-atomic="true"
            >
                <div class="toast-header">
                    <i class="fas fa-check-circle text-success me-2"></i>
                    <strong class="me-auto">OnlyPans</strong>
                    <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="toast"
                        aria-label="Close"
                    ></button>
                </div>
                <div class="toast-body fs-5 py-3" id="authToastMessage">
                    <!-- Message will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Recipe Success Toast - Top Center -->
        <div class="toast-container-auth">
            <div
                id="recipeSuccessToast"
                class="toast toast-min-width"
                role="alert"
                aria-live="assertive"
                aria-atomic="true"
            >
                <div class="toast-header">
                    <i class="fas fa-utensils text-primary me-2"></i>
                    <strong class="me-auto">OnlyPans</strong>
                    <button
                        type="button"
                        class="btn-close"
                        data-bs-dismiss="toast"
                        aria-label="Close"
                    ></button>
                </div>
                <div class="toast-body fs-5 py-3" id="recipeSuccessToastMessage">
                    <!-- Message will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Toast Container - Top Center -->
        <div
            class="toast-container-messages"
            aria-live="polite"
            aria-atomic="true"
        >
            <div class="toast-container">
                {% if messages %} {% for message in messages %}
                <div
                    class="toast align-items-center toast-min-width {% if message.tags == 'success' %}{% else %}text-white{% endif %} {% if message.tags == 'error' %}bg-danger{% elif message.tags == 'success' %}bg-custom-success{% else %}bg-info{% endif %} border-0"
                    role="alert"
                    aria-live="assertive"
                    aria-atomic="true"
                >
                    <div class="d-flex">
                        <div class="toast-body fs-5 py-3">{{ message }}</div>
                        <button
                            type="button"
                            class="btn-close btn-close-white me-2 m-auto"
                            data-bs-dismiss="toast"
                            aria-label="Close"
                        ></button>
                    </div>
                </div>
                {% endfor %} {% endif %}
            </div>
        </div>

        <!-- Contact Modal -->
        <div
            class="modal fade"
            id="contactModal"
            tabindex="-1"
            aria-labelledby="contactModalLabel"
            aria-hidden="true"
        >
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="contactModalLabel">
                            <i class="fas fa-phone me-2"></i>Contact Us
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div>
                    <div class="modal-body">
                        <div class="row">
                            <!-- Phone Contact -->
                            <div class="col-md-6 mb-4">
                                <div class="text-center p-4 bg-light rounded">
                                    <i class="fas fa-phone-alt text-primary fs-1 mb-3"></i>
                                    <h6 class="fw-bold">Call Us</h6>
                                    <p class="text-muted mb-2">We'd love to hear from you!</p>
                                    <p class="h5 text-primary mb-0">(555) 123-PANS</p>
                                    <small class="text-muted">Mon-Fri 9AM-6PM EST</small>
                                </div>
                            </div>
                            
                            <!-- Contact Form -->
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">Send us a message</h6>
                                <form id="contactForm">
                                    <div class="mb-3">
                                        <label for="contact_username" class="form-label">Name</label>
                                        <input
                                            type="text"
                                            class="form-control"
                                            id="contact_username"
                                            name="username"
                                            required
                                        />
                                    </div>
                                    <div class="mb-3">
                                        <label for="contact_email" class="form-label">Email</label>
                                        <input
                                            type="email"
                                            class="form-control"
                                            id="contact_email"
                                            name="email"
                                            required
                                        />
                                    </div>
                                    <div class="mb-3">
                                        <label for="contact_message" class="form-label">Message</label>
                                        <textarea
                                            class="form-control"
                                            id="contact_message"
                                            name="message"
                                            rows="4"
                                            required
                                        ></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary w-100">
                                        <i class="fas fa-paper-plane me-2"></i>Send Message
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bootstrap JS -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
        
        <!-- Custom App JS -->
        <script src="{% static 'js/app.js' %}"></script>
        <script>
            document.addEventListener("DOMContentLoaded", function () {
                // Function to show authentication toast messages
                function showAuthToast(message) {
                    const toastElement = document.getElementById("authToast");
                    const toastMessage =
                        document.getElementById("authToastMessage");

                    toastMessage.textContent = message;

                    const toast = new bootstrap.Toast(toastElement, {
                        autohide: true,
                        delay: 3000,
                    });

                    toast.show();
                }

                // Handle login form submission via AJAX
                const loginForm = document.getElementById("loginForm");
                if (loginForm) {
                    loginForm.addEventListener("submit", function (e) {
                        e.preventDefault();

                        const formData = new FormData(this);
                        const errorDiv = document.getElementById("loginErrors");

                        fetch(this.action, {
                            method: "POST",
                            body: formData,
                            headers: {
                                "X-Requested-With": "XMLHttpRequest",
                            },
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                if (data.success) {
                                    // Show welcome toast
                                    const firstName =
                                        data.first_name || data.username;
                                    showAuthToast(
                                        `Welcome back, ${firstName}!`
                                    );

                                    // Close modal and reload page after short delay
                                    bootstrap.Modal.getInstance(
                                        document.getElementById("loginModal")
                                    ).hide();

                                    setTimeout(() => {
                                        location.reload();
                                    }, 1500);
                                } else {
                                    // Show error in modal
                                    errorDiv.textContent =
                                        data.error ||
                                        "Login failed. Please try again.";
                                    errorDiv.style.display = "block";
                                }
                            })
                            .catch((error) => {
                                errorDiv.textContent =
                                    "An error occurred. Please try again.";
                                errorDiv.style.display = "block";
                            });
                    });
                }

                // Handle registration form submission via AJAX
                const registerForm = document.getElementById("registerForm");
                if (registerForm) {
                    registerForm.addEventListener("submit", function (e) {
                        e.preventDefault();

                        const formData = new FormData(this);
                        const errorDiv =
                            document.getElementById("registerErrors");

                        fetch(this.action, {
                            method: "POST",
                            body: formData,
                            headers: {
                                "X-Requested-With": "XMLHttpRequest",
                            },
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                if (data.success) {
                                    // Show welcome toast
                                    const firstName =
                                        data.first_name || data.username;
                                    showAuthToast(
                                        `Welcome to OnlyPans, ${firstName}!`
                                    );

                                    // Close modal and reload page after short delay
                                    bootstrap.Modal.getInstance(
                                        document.getElementById("registerModal")
                                    ).hide();

                                    setTimeout(() => {
                                        location.reload();
                                    }, 1500);
                                } else {
                                    // Show error in modal
                                    errorDiv.textContent =
                                        data.error ||
                                        "Registration failed. Please try again.";
                                    errorDiv.style.display = "block";
                                }
                            })
                            .catch((error) => {
                                errorDiv.textContent =
                                    "An error occurred. Please try again.";
                                errorDiv.style.display = "block";
                            });
                    });
                }

                // Handle logout via AJAX
                const logoutBtn = document.getElementById("logoutBtn");
                if (logoutBtn) {
                    function getCookie(name) {
                        const value = `; ${document.cookie}`;
                        const parts = value.split(`; ${name}=`);
                        if (parts.length === 2) return parts.pop().split(';').shift();
                    }
                    logoutBtn.addEventListener("click", function (e) {
                        e.preventDefault();

                        fetch("{% url 'accounts:logout' %}", {
                            method: "POST",
                            headers: {
                                "X-Requested-With": "XMLHttpRequest",
                                // Prefer cookie-based CSRF for global availability
                                "X-CSRFToken": getCookie("csrftoken") || (document.querySelector("[name=csrfmiddlewaretoken]")?.value || ""),
                            },
                        })
                            .then((response) => response.json())
                            .then((data) => {
                                if (data.success) {
                                    // Show goodbye toast
                                    showAuthToast(data.message);

                                    // Redirect to home page after short delay
                                    setTimeout(() => {
                                        window.location.href = "{% url 'recipes:recipe_list' %}";
                                    }, 1500);
                                }
                            })
                            .catch((error) => {
                                console.error("Logout error:", error);
                                // Fallback to regular logout
                                window.location.href = "{% url 'accounts:logout' %}";
                            });
                    });
                }

                // Clear errors when modals are opened
                document
                    .getElementById("loginModal")
                    .addEventListener("show.bs.modal", function () {
                        const errorDiv = document.getElementById("loginErrors");
                        if (errorDiv) {
                            errorDiv.style.display = "none";
                            errorDiv.textContent = "";
                        }
                    });

                document
                    .getElementById("registerModal")
                    .addEventListener("show.bs.modal", function () {
                        const errorDiv =
                            document.getElementById("registerErrors");
                        if (errorDiv) {
                            errorDiv.style.display = "none";
                            errorDiv.textContent = "";
                        }
                    });

                // Handle contact form submission
                const contactForm = document.getElementById("contactForm");
                if (contactForm) {
                    contactForm.addEventListener("submit", function (e) {
                        e.preventDefault();
                        
                        // Show success message
                        showAuthToast("Thank you! We'll get back to you soon.");
                        
                        // Close modal
                        bootstrap.Modal.getInstance(
                            document.getElementById("contactModal")
                        ).hide();
                        
                        // Reset form
                        contactForm.reset();
                    });
                }
            });
        </script>
        {% block extra_js %}{% endblock %}
    </body>
</html>
